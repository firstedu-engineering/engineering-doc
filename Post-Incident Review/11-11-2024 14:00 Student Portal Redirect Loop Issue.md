# Post-Incident Review: Student Portal Redirect Loop Issue

---

## 1. 事件概述

- **事件名称：** 学生端重定向死循环问题
- **发生日期：** 11-11-2024 14:00
- **影响范围：** 学生端用户；影响登录及页面加载，导致用户无法正常使用系统
- **事件类型：** 服务中断
- **事件等级：** 高
- **事件负责人：** 吴昊阳

---

## 2. 事件时间线

| 时间  | 事件     | 描述                                      | 负责人 |
| ----- | -------- | ----------------------------------------- | ------ |
| 14:06 | 初步发现 | 上线后 6 分钟，学生端出现重定向死循环问题 |        |
| 14:08 | 通报     | 问题被发现后，迅速通报至相关团队          |        |
| 14:08 | 响应开始 | 团队开始分析问题并计划回滚修复            |        |
| 14:14 | 初步缓解 | 通过回滚 `manifest` commit 暂时修复问题   |        |
| 14:14 | 完全解决 | 问题解决，学生端恢复正常服务              |        |
| 16:00 | 回顾会   | 召开 PIR 会议，讨论问题根因及改进措施     |        |

---

## 3. 事件影响

- **对业务的影响：**

  - 学生端用户无法正常登录，系统陷入重定向死循环，导致用户无法访问应用，影响了正常的业务流程和用户体验。

- **对客户的影响：**
  - 所有试图登录的学生端用户都受到影响，出现页面无法加载和无限重定向的现象，用户体验严重受损。

---

## 4. 根因分析

- **事件原因概述：**

  - AI 助手未按登录状态隐藏的需求没有写入故事卡的验收标准（AC），导致上线前遗漏检查，并临时调整导致问题。

- **根因分类：**

  - 需求管理问题、临时变更引入的代码缺陷

- **详细原因分析：**
  - 根据校长临时提出的反馈，快速在 `useAuth` 中使用 `currentUser` GraphQL 请求判断登录状态，并在未登录时隐藏 AI 助手。此逻辑在测试环境下通过，但生产环境中 `currentUser` 请求返回 `302` 状态码，浏览器自动进行重定向，导致页面陷入死循环。

---

## 5. 响应和恢复措施

- **恢复措施：**

  - 迅速回滚 `manifest` commit，恢复至稳定版本。

- **恢复时间：**
  - 回滚修复耗时 8 分钟，从 14:06 到 14:14。

---

## 6. 改进与防范措施

- **短期改进措施：**

  1. 在上线前的检查流程中，严格核对所有故事卡的验收标准（AC），确保需求和功能符合预期。
  2. 明确拒绝未经确认的临时需求变更，确保变更经过评审和充分测试。

- **长期防范措施：**

  1. 对登录状态的判断逻辑进行重构，采用更安全且明确的方式（如使用明确的登录状态标识，而不是依赖 HTTP 请求的重定向状态码）。
  2. 加强变更管理流程，避免未经评审的紧急修改直接上线，特别是在生产环境。

---

## 7. 学习和教训

- **哪些响应措施有效？**

  - 迅速回滚版本是有效的缓解措施，及时恢复了系统正常服务，避免了更大范围的用户影响。

- **哪些方面可以改进？**

  - 应在需求评审阶段确保故事卡的 AC 完整性，避免遗漏影响业务功能的关键需求。
  - 临时变更应经过评审和测试，而不应直接上线，尤其是在生产环境。

- **从事件中学到的关键经验：**

  - 需求变更和功能修复时必须经过完整的流程，避免因为快速调整而引发意外问题。
  - 登录状态的判断逻辑应更明确，避免使用 HTTP 重定向状态码这种容易导致浏览器意外行为的判断方式。

---

## 8. 结论与后续行动

- **总结：**

  - 此次事件是由于临时需求调整导致未经过评审的变更直接上线所引发的，虽然回滚及时，但影响了学生端用户的正常使用。此次事件为我们敲响了警钟，需加强需求管理和变更控制流程。

- **后续行动列表：**

  1. **需求评审流程改进：** 在需求评审时，确保验收标准（AC）的完整性和准确性。
  2. **变更管理流程改进：** 明确未经确认的需求反馈不得直接调整生产代码。
  3. **登录状态判断逻辑重构：** 重构登录状态判断，避免使用 HTTP 重定向状态码。
